import { __awaiter } from "tslib";
import { Component, EventEmitter, Inject, Input, Optional, Output, QueryList, ViewChildren } from '@angular/core';
import { CodeInputComponentConfigToken, defaultComponentConfig } from './code-input.component.config';
var InputState;
(function (InputState) {
    InputState[InputState["ready"] = 0] = "ready";
    InputState[InputState["reset"] = 1] = "reset";
})(InputState || (InputState = {}));
export class CodeInputComponent {
    constructor(config) {
        /** @deprecated Use isCharsCode prop instead. */
        this.isNonDigitsCode = false;
        this.codeChanged = new EventEmitter();
        this.codeCompleted = new EventEmitter();
        this.placeholders = [];
        this.inputs = [];
        this.inputsStates = [];
        this.state = {
            isFocusingAfterAppearingCompleted: false,
            isInitialFocusFieldEnabled: false
        };
        Object.assign(this, defaultComponentConfig);
        if (!config) {
            return;
        }
        // filtering for only valid config props
        for (const prop in config) {
            if (!config.hasOwnProperty(prop)) {
                continue;
            }
            if (!defaultComponentConfig.hasOwnProperty(prop)) {
                continue;
            }
            // @ts-ignore
            this[prop] = config[prop];
        }
    }
    /**
     * Life cycle
     */
    ngOnInit() {
        // defining the state
        this.state.isInitialFocusFieldEnabled = !this.isEmpty(this.initialFocusField);
        // initiating the code
        this.onCodeLengthChanges();
    }
    ngAfterViewInit() {
        // initiation of the inputs
        this.inputsListSubscription = this.inputsList.changes.subscribe(this.onInputsListChanges.bind(this));
        this.onInputsListChanges(this.inputsList);
    }
    ngAfterViewChecked() {
        this.focusOnInputAfterAppearing();
    }
    ngOnChanges(changes) {
        if (changes.code) {
            this.onInputCodeChanges();
        }
        if (changes.codeLength) {
            this.onCodeLengthChanges();
        }
    }
    ngOnDestroy() {
        if (this.inputsListSubscription) {
            this.inputsListSubscription.unsubscribe();
        }
    }
    /**
     * Methods
     */
    reset(isChangesEmitting = false) {
        // resetting the code to its initial value or to an empty value
        this.onInputCodeChanges();
        if (this.state.isInitialFocusFieldEnabled) {
            // tslint:disable-next-line:no-non-null-assertion
            this.focusOnField(this.initialFocusField);
        }
        if (isChangesEmitting) {
            this.emitChanges();
        }
    }
    focusOnField(index) {
        if (index >= this._codeLength) {
            throw new Error('The index of the focusing input box should be less than the codeLength.');
        }
        this.inputs[index].focus();
    }
    onClick(e) {
        // handle click events only if the the prop is enabled
        if (!this.isFocusingOnLastByClickIfFilled) {
            return;
        }
        const target = e.target;
        const last = this.inputs[this._codeLength - 1];
        // already focused
        if (target === last) {
            return;
        }
        // check filling
        const isFilled = this.getCurrentFilledCode().length >= this._codeLength;
        if (!isFilled) {
            return;
        }
        // focusing on the last input if is filled
        setTimeout(() => last.focus());
    }
    onInput(e, i) {
        const target = e.target;
        const value = e.data || target.value;
        if (this.isEmpty(value)) {
            return;
        }
        // only digits are allowed if isCharsCode flag is absent/false
        if (!this.canInputValue(value)) {
            e.preventDefault();
            e.stopPropagation();
            this.setInputValue(target, null);
            this.setStateForInput(target, InputState.reset);
            return;
        }
        const values = value.toString().trim().split('');
        for (let j = 0; j < values.length; j++) {
            const index = j + i;
            if (index > this._codeLength - 1) {
                break;
            }
            this.setInputValue(this.inputs[index], values[j]);
        }
        this.emitChanges();
        const next = i + values.length;
        if (next > this._codeLength - 1) {
            target.blur();
            return;
        }
        this.inputs[next].focus();
    }
    onPaste(e, i) {
        e.preventDefault();
        e.stopPropagation();
        const data = e.clipboardData ? e.clipboardData.getData('text').trim() : undefined;
        if (this.isEmpty(data)) {
            return;
        }
        // Convert paste text into iterable
        // tslint:disable-next-line:no-non-null-assertion
        const values = data.split('');
        let valIndex = 0;
        for (let j = i; j < this.inputs.length; j++) {
            // The values end is reached. Loop exit
            if (valIndex === values.length) {
                break;
            }
            const input = this.inputs[j];
            const val = values[valIndex];
            // Cancel the loop when a value cannot be used
            if (!this.canInputValue(val)) {
                this.setInputValue(input, null);
                this.setStateForInput(input, InputState.reset);
                return;
            }
            this.setInputValue(input, val.toString());
            valIndex++;
        }
        this.inputs[i].blur();
        this.emitChanges();
    }
    onKeydown(e, i) {
        return __awaiter(this, void 0, void 0, function* () {
            const target = e.target;
            const isTargetEmpty = this.isEmpty(target.value);
            const prev = i - 1;
            // processing only the backspace and delete key events
            const isBackspaceKey = yield this.isBackspaceKey(e);
            const isDeleteKey = this.isDeleteKey(e);
            if (!isBackspaceKey && !isDeleteKey) {
                return;
            }
            e.preventDefault();
            this.setInputValue(target, null);
            if (!isTargetEmpty) {
                this.emitChanges();
            }
            // preventing to focusing on the previous field if it does not exist or the delete key has been pressed
            if (prev < 0 || isDeleteKey) {
                return;
            }
            if (isTargetEmpty || this.isPrevFocusableAfterClearing) {
                this.inputs[prev].focus();
            }
        });
    }
    onInputCodeChanges() {
        if (!this.inputs.length) {
            return;
        }
        if (this.isEmpty(this.code)) {
            this.inputs.forEach((input) => {
                this.setInputValue(input, null);
            });
            return;
        }
        // tslint:disable-next-line:no-non-null-assertion
        const chars = this.code.toString().trim().split('');
        // checking if all the values are correct
        let isAllCharsAreAllowed = true;
        for (const char of chars) {
            if (!this.canInputValue(char)) {
                isAllCharsAreAllowed = false;
                break;
            }
        }
        this.inputs.forEach((input, index) => {
            const value = isAllCharsAreAllowed ? chars[index] : null;
            this.setInputValue(input, value);
        });
    }
    onCodeLengthChanges() {
        if (!this.codeLength) {
            return;
        }
        this._codeLength = this.codeLength;
        if (this._codeLength > this.placeholders.length) {
            const numbers = Array(this._codeLength - this.placeholders.length).fill(1);
            this.placeholders.splice(this.placeholders.length - 1, 0, ...numbers);
        }
        else if (this._codeLength < this.placeholders.length) {
            this.placeholders.splice(this._codeLength);
        }
    }
    onInputsListChanges(list) {
        if (list.length > this.inputs.length) {
            const inputsToAdd = list.filter((item, index) => index > this.inputs.length - 1);
            this.inputs.splice(this.inputs.length, 0, ...inputsToAdd.map(item => item.nativeElement));
            const states = Array(inputsToAdd.length).fill(InputState.ready);
            this.inputsStates.splice(this.inputsStates.length, 0, ...states);
        }
        else if (list.length < this.inputs.length) {
            this.inputs.splice(list.length);
            this.inputsStates.splice(list.length);
        }
        // filling the inputs after changing of their count
        this.onInputCodeChanges();
    }
    focusOnInputAfterAppearing() {
        if (!this.state.isInitialFocusFieldEnabled) {
            return;
        }
        if (this.state.isFocusingAfterAppearingCompleted) {
            return;
        }
        // tslint:disable-next-line:no-non-null-assertion
        this.focusOnField(this.initialFocusField);
        // tslint:disable-next-line:no-non-null-assertion
        this.state.isFocusingAfterAppearingCompleted = document.activeElement === this.inputs[this.initialFocusField];
    }
    emitChanges() {
        setTimeout(() => this.emitCode(), 50);
    }
    emitCode() {
        const code = this.getCurrentFilledCode();
        this.codeChanged.emit(code);
        if (code.length >= this._codeLength) {
            this.codeCompleted.emit(code);
        }
    }
    getCurrentFilledCode() {
        let code = '';
        for (const input of this.inputs) {
            if (!this.isEmpty(input.value)) {
                code += input.value;
            }
        }
        return code;
    }
    isBackspaceKey(e) {
        const isBackspace = (e.key && e.key.toLowerCase() === 'backspace') || (e.keyCode && e.keyCode === 8);
        if (isBackspace) {
            return Promise.resolve(true);
        }
        // process only key with placeholder keycode on android devices
        if (!e.keyCode || e.keyCode !== 229) {
            return Promise.resolve(false);
        }
        return new Promise((resolve) => {
            setTimeout(() => {
                const input = e.target;
                const isReset = this.getStateForInput(input) === InputState.reset;
                if (isReset) {
                    this.setStateForInput(input, InputState.ready);
                }
                // if backspace key pressed the caret will have position 0 (for single value field)
                resolve(input.selectionStart === 0 && !isReset);
            });
        });
    }
    isDeleteKey(e) {
        return (e.key && e.key.toLowerCase() === 'delete') || (e.keyCode && e.keyCode === 46);
    }
    setInputValue(input, value) {
        const isEmpty = this.isEmpty(value);
        const valueClassCSS = 'has-value';
        const emptyClassCSS = 'empty';
        if (isEmpty) {
            input.value = '';
            input.classList.remove(valueClassCSS);
            // tslint:disable-next-line:no-non-null-assertion
            input.parentElement.classList.add(emptyClassCSS);
        }
        else {
            input.value = value;
            input.classList.add(valueClassCSS);
            // tslint:disable-next-line:no-non-null-assertion
            input.parentElement.classList.remove(emptyClassCSS);
        }
    }
    canInputValue(value) {
        if (this.isEmpty(value)) {
            return false;
        }
        const isDigitsValue = /^[0-9]+$/.test(value.toString());
        return isDigitsValue || (this.isCharsCode || this.isNonDigitsCode);
    }
    setStateForInput(input, state) {
        const index = this.inputs.indexOf(input);
        if (index < 0) {
            return;
        }
        this.inputsStates[index] = state;
    }
    getStateForInput(input) {
        const index = this.inputs.indexOf(input);
        return this.inputsStates[index];
    }
    isEmpty(value) {
        return value === null || value === undefined || !value.toString().length;
    }
}
/** @type {!Array<{type: !Function, args: (undefined|!Array<?>)}>} */
CodeInputComponent.decorators = [
    { type: Component, args: [{
                // tslint:disable-next-line:component-selector
                selector: 'code-input',
                template: "<span *ngFor=\"let holder of placeholders; index as i\"\n      [class.code-hidden]=\"isCodeHidden\">\n  <input #input\n         (click)=\"onClick($event)\"\n         (paste)=\"onPaste($event, i)\"\n         (input)=\"onInput($event, i)\"\n         (keydown)=\"onKeydown($event, i)\"\n         [type]=\"inputType\"\n         [disabled]=\"disabled\"\n         [attr.autocapitalize]=\"autocapitalize\"\n         autocomplete=\"one-time-code\"/>\n</span>\n",
                styles: [":host{--text-security-type:disc;--item-spacing:4px;--item-height:4.375em;--item-border:1px solid #ddd;--item-border-bottom:1px solid #ddd;--item-border-has-value:1px solid #ddd;--item-border-bottom-has-value:1px solid #ddd;--item-border-focused:1px solid #ddd;--item-border-bottom-focused:1px solid #ddd;--item-shadow-focused:0px 1px 5px #ddd;--item-border-radius:5px;--item-background:transparent;--color:#171516;display:flex;transform:translateZ(0);font-size:inherit;color:var(--color)}:host span{display:block;flex:1;padding-right:var(--item-spacing)}:host span:first-child{padding-left:var(--item-spacing)}:host span.code-hidden input{text-security:var(--text-security-type);-webkit-text-security:var(--text-security-type);-moz-text-security:var(--text-security-type)}:host input{width:100%;height:var(--item-height);color:inherit;background:var(--item-background);text-align:center;font-size:inherit;border:var(--item-border);border-bottom:var(--item-border-bottom);border-radius:var(--item-border-radius);-webkit-appearance:none;transform:translateZ(0);-webkit-transform:translateZ(0);outline:none}:host input.has-value{border:var(--item-border-has-value);border-bottom:var(--item-border-bottom-has-value)}:host input:focus{border:var(--item-border-focused);border-bottom:var(--item-border-bottom-focused);box-shadow:var(--item-shadow-focused)}"]
            },] }
];
/**
 * @type {function(): !Array<(null|{
 *   type: ?,
 *   decorators: (undefined|!Array<{type: !Function, args: (undefined|!Array<?>)}>),
 * })>}
 * @nocollapse
 */
CodeInputComponent.ctorParameters = () => [
    { type: undefined, decorators: [{ type: Optional }, { type: Inject, args: [CodeInputComponentConfigToken,] }] }
];
/** @type {!Object<string, !Array<{type: !Function, args: (undefined|!Array<?>)}>>} */
CodeInputComponent.propDecorators = {
    inputsList: [{ type: ViewChildren, args: ['input',] }],
    codeLength: [{ type: Input }],
    inputType: [{ type: Input }],
    initialFocusField: [{ type: Input }],
    isNonDigitsCode: [{ type: Input }],
    isCharsCode: [{ type: Input }],
    isCodeHidden: [{ type: Input }],
    isPrevFocusableAfterClearing: [{ type: Input }],
    isFocusingOnLastByClickIfFilled: [{ type: Input }],
    code: [{ type: Input }],
    disabled: [{ type: Input }],
    autocapitalize: [{ type: Input }],
    codeChanged: [{ type: Output }],
    codeCompleted: [{ type: Output }]
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29kZS1pbnB1dC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9hbmd1bGFyLWNvZGUtaW5wdXQvc3JjL2xpYi9jb2RlLWlucHV0LmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUdMLFNBQVMsRUFFVCxZQUFZLEVBQ1osTUFBTSxFQUNOLEtBQUssRUFJTCxRQUFRLEVBQ1IsTUFBTSxFQUNOLFNBQVMsRUFFVCxZQUFZLEVBQ2IsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUVMLDZCQUE2QixFQUM3QixzQkFBc0IsRUFDdkIsTUFBTSwrQkFBK0IsQ0FBQztBQUd2QyxJQUFLLFVBR0o7QUFIRCxXQUFLLFVBQVU7SUFDYiw2Q0FBUyxDQUFBO0lBQ1QsNkNBQVMsQ0FBQTtBQUNYLENBQUMsRUFISSxVQUFVLEtBQVYsVUFBVSxRQUdkO0FBUUQsTUFBTSxPQUFPLGtCQUFrQjtJQWlDN0IsWUFBK0QsTUFBaUM7UUExQmhHLGdEQUFnRDtRQUN2QyxvQkFBZSxHQUFHLEtBQUssQ0FBQztRQVNkLGdCQUFXLEdBQUcsSUFBSSxZQUFZLEVBQVUsQ0FBQztRQUN6QyxrQkFBYSxHQUFHLElBQUksWUFBWSxFQUFVLENBQUM7UUFFdkQsaUJBQVksR0FBYSxFQUFFLENBQUM7UUFFM0IsV0FBTSxHQUF1QixFQUFFLENBQUM7UUFDaEMsaUJBQVksR0FBaUIsRUFBRSxDQUFDO1FBS2hDLFVBQUssR0FBRztZQUNkLGlDQUFpQyxFQUFFLEtBQUs7WUFDeEMsMEJBQTBCLEVBQUUsS0FBSztTQUNsQyxDQUFDO1FBR0EsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsc0JBQXNCLENBQUMsQ0FBQztRQUU1QyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ1gsT0FBTztTQUNSO1FBRUQsd0NBQXdDO1FBQ3hDLEtBQUssTUFBTSxJQUFJLElBQUksTUFBTSxFQUFFO1lBQ3pCLElBQUksQ0FBQyxNQUFN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LFFBQVEsRUFBRSxZQUFZO2dCQUN0QixnZEFBd0M7O2FBRXpDOzs7Ozs7Ozs7OzRDQWtDYyxRQUFRLFlBQUksTUFBTSxTQUFDLDZCQUE2Qjs7Ozt5QkEvQjVELFlBQVksU0FBQyxPQUFPO3lCQUVwQixLQUFLO3dCQUNMLEtBQUs7Z0NBQ0wsS0FBSzs4QkFFTCxLQUFLOzBCQUNMLEtBQUs7MkJBQ0wsS0FBSzsyQ0FDTCxLQUFLOzhDQUNMLEtBQUs7bUJBQ0wsS0FBSzt1QkFDTCxLQUFLOzZCQUNMLEtBQUs7MEJBRUwsTUFBTTs0QkFDTixNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQWZ0ZXJWaWV3Q2hlY2tlZCxcbiAgQWZ0ZXJWaWV3SW5pdCxcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIEluamVjdCxcbiAgSW5wdXQsXG4gIE9uQ2hhbmdlcyxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG4gIE9wdGlvbmFsLFxuICBPdXRwdXQsXG4gIFF1ZXJ5TGlzdCxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgVmlld0NoaWxkcmVuXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtcbiAgQ29kZUlucHV0Q29tcG9uZW50Q29uZmlnLFxuICBDb2RlSW5wdXRDb21wb25lbnRDb25maWdUb2tlbixcbiAgZGVmYXVsdENvbXBvbmVudENvbmZpZ1xufSBmcm9tICcuL2NvZGUtaW5wdXQuY29tcG9uZW50LmNvbmZpZyc7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuZW51bSBJbnB1dFN0YXRlIHtcbiAgcmVhZHkgPSAwLFxuICByZXNldCA9IDFcbn1cblxuQENvbXBvbmVudCh7XG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpjb21wb25lbnQtc2VsZWN0b3JcbiAgc2VsZWN0b3I6ICdjb2RlLWlucHV0JyxcbiAgdGVtcGxhdGVVcmw6ICdjb2RlLWlucHV0LmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmxzOiBbJy4vY29kZS1pbnB1dC5jb21wb25lbnQuc2NzcyddXG59KVxuZXhwb3J0IGNsYXNzIENvZGVJbnB1dENvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uSW5pdCwgT25DaGFuZ2VzLCBPbkRlc3Ryb3ksIEFmdGVyVmlld0NoZWNrZWQsIENvZGVJbnB1dENvbXBvbmVudENvbmZpZyB7XG5cbiAgQFZpZXdDaGlsZHJlbignaW5wdXQnKSBpbnB1dHNMaXN0ICE6IFF1ZXJ5TGlzdDxFbGVtZW50UmVmPjtcblxuICBASW5wdXQoKSBjb2RlTGVuZ3RoICE6IG51bWJlcjtcbiAgQElucHV0KCkgaW5wdXRUeXBlICE6IHN0cmluZztcbiAgQElucHV0KCkgaW5pdGlhbEZvY3VzRmllbGQ/OiBudW1iZXI7XG4gIC8qKiBAZGVwcmVjYXRlZCBVc2UgaXNDaGFyc0NvZGUgcHJvcCBpbnN0ZWFkLiAqL1xuICBASW5wdXQoKSBpc05vbkRpZ2l0c0NvZGUgPSBmYWxzZTtcbiAgQElucHV0KCkgaXNDaGFyc0NvZGUgITogYm9vbGVhbjtcbiAgQElucHV0KCkgaXNDb2RlSGlkZGVuICE6IGJvb2xlYW47XG4gIEBJbnB1dCgpIGlzUHJldkZvY3VzYWJsZUFmdGVyQ2xlYXJpbmcgITogYm9vbGVhbjtcbiAgQElucHV0KCkgaXNGb2N1c2luZ09uTGFzdEJ5Q2xpY2tJZkZpbGxlZCAhOiBib29sZWFuO1xuICBASW5wdXQoKSBjb2RlID86IHN0cmluZyB8IG51bWJlcjtcbiAgQElucHV0KCkgZGlzYWJsZWQgITogYm9vbGVhbjtcbiAgQElucHV0KCkgYXV0b2NhcGl0YWxpemUgPzogc3RyaW5nO1xuXG4gIEBPdXRwdXQoKSByZWFkb25seSBjb2RlQ2hhbmdlZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuICBAT3V0cHV0KCkgcmVhZG9ubHkgY29kZUNvbXBsZXRlZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nPigpO1xuXG4gIHB1YmxpYyBwbGFjZWhvbGRlcnM6IG51bWJlcltdID0gW107XG5cbiAgcHJpdmF0ZSBpbnB1dHM6IEhUTUxJbnB1dEVsZW1lbnRbXSA9IFtdO1xuICBwcml2YXRlIGlucHV0c1N0YXRlczogSW5wdXRTdGF0ZVtdID0gW107XG4gIHByaXZhdGUgaW5wdXRzTGlzdFN1YnNjcmlwdGlvbiAhOiBTdWJzY3JpcHRpb247XG5cbiAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOnZhcmlhYmxlLW5hbWVcbiAgcHJpdmF0ZSBfY29kZUxlbmd0aCAhOiBudW1iZXI7XG4gIHByaXZhdGUgc3RhdGUgPSB7XG4gICAgaXNGb2N1c2luZ0FmdGVyQXBwZWFyaW5nQ29tcGxldGVkOiBmYWxzZSxcbiAgICBpc0luaXRpYWxGb2N1c0ZpZWxkRW5hYmxlZDogZmFsc2VcbiAgfTtcblxuICBjb25zdHJ1Y3RvcihAT3B0aW9uYWwoKSBASW5qZWN0KENvZGVJbnB1dENvbXBvbmVudENvbmZpZ1Rva2VuKSBjb25maWc/OiBDb2RlSW5wdXRDb21wb25lbnRDb25maWcpIHtcbiAgICBPYmplY3QuYXNzaWduKHRoaXMsIGRlZmF1bHRDb21wb25lbnRDb25maWcpO1xuXG4gICAgaWYgKCFjb25maWcpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBmaWx0ZXJpbmcgZm9yIG9ubHkgdmFsaWQgY29uZmlnIHByb3BzXG4gICAgZm9yIChjb25zdCBwcm9wIGluIGNvbmZpZykge1xuICAgICAgaWYgKCFjb25maWcuaGFzT3duUHJvcGVydHkocHJvcCkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGlmICghZGVmYXVsdENvbXBvbmVudENvbmZpZy5oYXNPd25Qcm9wZXJ0eShwcm9wKSkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgLy8gQHRzLWlnbm9yZVxuICAgICAgdGhpc1twcm9wXSA9IGNvbmZpZ1twcm9wXTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTGlmZSBjeWNsZVxuICAgKi9cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICAvLyBkZWZpbmluZyB0aGUgc3RhdGVcbiAgICB0aGlzLnN0YXRlLmlzSW5pdGlhbEZvY3VzRmllbGRFbmFibGVkID0gIXRoaXMuaXNFbXB0eSh0aGlzLmluaXRpYWxGb2N1c0ZpZWxkKTtcbiAgICAvLyBpbml0aWF0aW5nIHRoZSBjb2RlXG4gICAgdGhpcy5vbkNvZGVMZW5ndGhDaGFuZ2VzKCk7XG4gIH1cblxuICBuZ0FmdGVyVmlld0luaXQoKTogdm9pZCB7XG4gICAgLy8gaW5pdGlhdGlvbiBvZiB0aGUgaW5wdXRzXG4gICAgdGhpcy5pbnB1dHNMaXN0U3Vic2NyaXB0aW9uID0gdGhpcy5pbnB1dHNMaXN0LmNoYW5nZXMuc3Vic2NyaWJlKHRoaXMub25JbnB1dHNMaXN0Q2hhbmdlcy5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLm9uSW5wdXRzTGlzdENoYW5nZXModGhpcy5pbnB1dHNMaXN0KTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3Q2hlY2tlZCgpOiB2b2lkIHtcbiAgICB0aGlzLmZvY3VzT25JbnB1dEFmdGVyQXBwZWFyaW5nKCk7XG4gIH1cblxuICBuZ09uQ2hhbmdlcyhjaGFuZ2VzOiBTaW1wbGVDaGFuZ2VzKTogdm9pZCB7XG4gICAgaWYgKGNoYW5nZXMuY29kZSkge1xuICAgICAgdGhpcy5vbklucHV0Q29kZUNoYW5nZXMoKTtcbiAgICB9XG4gICAgaWYgKGNoYW5nZXMuY29kZUxlbmd0aCkge1xuICAgICAgdGhpcy5vbkNvZGVMZW5ndGhDaGFuZ2VzKCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaW5wdXRzTGlzdFN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5pbnB1dHNMaXN0U3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIE1ldGhvZHNcbiAgICovXG5cbiAgcmVzZXQoaXNDaGFuZ2VzRW1pdHRpbmcgPSBmYWxzZSk6IHZvaWQge1xuICAgIC8vIHJlc2V0dGluZyB0aGUgY29kZSB0byBpdHMgaW5pdGlhbCB2YWx1ZSBvciB0byBhbiBlbXB0eSB2YWx1ZVxuICAgIHRoaXMub25JbnB1dENvZGVDaGFuZ2VzKCk7XG5cbiAgICBpZiAodGhpcy5zdGF0ZS5pc0luaXRpYWxGb2N1c0ZpZWxkRW5hYmxlZCkge1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW5vbi1udWxsLWFzc2VydGlvblxuICAgICAgdGhpcy5mb2N1c09uRmllbGQodGhpcy5pbml0aWFsRm9jdXNGaWVsZCEpO1xuICAgIH1cblxuICAgIGlmIChpc0NoYW5nZXNFbWl0dGluZykge1xuICAgICAgdGhpcy5lbWl0Q2hhbmdlcygpO1xuICAgIH1cbiAgfVxuXG4gIGZvY3VzT25GaWVsZChpbmRleDogbnVtYmVyKTogdm9pZCB7XG4gICAgaWYgKGluZGV4ID49IHRoaXMuX2NvZGVMZW5ndGgpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignVGhlIGluZGV4IG9mIHRoZSBmb2N1c2luZyBpbnB1dCBib3ggc2hvdWxkIGJlIGxlc3MgdGhhbiB0aGUgY29kZUxlbmd0aC4nKTtcbiAgICB9XG5cbiAgICB0aGlzLmlucHV0c1tpbmRleF0uZm9jdXMoKTtcbiAgfVxuXG4gIG9uQ2xpY2soZTogYW55KTogdm9pZCB7XG4gICAgLy8gaGFuZGxlIGNsaWNrIGV2ZW50cyBvbmx5IGlmIHRoZSB0aGUgcHJvcCBpcyBlbmFibGVkXG4gICAgaWYgKCF0aGlzLmlzRm9jdXNpbmdPbkxhc3RCeUNsaWNrSWZGaWxsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldDtcbiAgICBjb25zdCBsYXN0ID0gdGhpcy5pbnB1dHNbdGhpcy5fY29kZUxlbmd0aCAtIDFdO1xuICAgIC8vIGFscmVhZHkgZm9jdXNlZFxuICAgIGlmICh0YXJnZXQgPT09IGxhc3QpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBjaGVjayBmaWxsaW5nXG4gICAgY29uc3QgaXNGaWxsZWQgPSB0aGlzLmdldEN1cnJlbnRGaWxsZWRDb2RlKCkubGVuZ3RoID49IHRoaXMuX2NvZGVMZW5ndGg7XG4gICAgaWYgKCFpc0ZpbGxlZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGZvY3VzaW5nIG9uIHRoZSBsYXN0IGlucHV0IGlmIGlzIGZpbGxlZFxuICAgIHNldFRpbWVvdXQoKCkgPT4gbGFzdC5mb2N1cygpKTtcbiAgfVxuXG4gIG9uSW5wdXQoZTogYW55LCBpOiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldDtcbiAgICBjb25zdCB2YWx1ZSA9IGUuZGF0YSB8fCB0YXJnZXQudmFsdWU7XG5cbiAgICBpZiAodGhpcy5pc0VtcHR5KHZhbHVlKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIG9ubHkgZGlnaXRzIGFyZSBhbGxvd2VkIGlmIGlzQ2hhcnNDb2RlIGZsYWcgaXMgYWJzZW50L2ZhbHNlXG4gICAgaWYgKCF0aGlzLmNhbklucHV0VmFsdWUodmFsdWUpKSB7XG4gICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuICAgICAgdGhpcy5zZXRJbnB1dFZhbHVlKHRhcmdldCwgbnVsbCk7XG4gICAgICB0aGlzLnNldFN0YXRlRm9ySW5wdXQodGFyZ2V0LCBJbnB1dFN0YXRlLnJlc2V0KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB2YWx1ZXMgPSB2YWx1ZS50b1N0cmluZygpLnRyaW0oKS5zcGxpdCgnJyk7XG4gICAgZm9yIChsZXQgaiA9IDA7IGogPCB2YWx1ZXMubGVuZ3RoOyBqKyspIHtcbiAgICAgIGNvbnN0IGluZGV4ID0gaiArIGk7XG4gICAgICBpZiAoaW5kZXggPiB0aGlzLl9jb2RlTGVuZ3RoIC0gMSkge1xuICAgICAgICBicmVhaztcbiAgICAgIH1cblxuICAgICAgdGhpcy5zZXRJbnB1dFZhbHVlKHRoaXMuaW5wdXRzW2luZGV4XSwgdmFsdWVzW2pdKTtcbiAgICB9XG4gICAgdGhpcy5lbWl0Q2hhbmdlcygpO1xuXG4gICAgY29uc3QgbmV4dCA9IGkgKyB2YWx1ZXMubGVuZ3RoO1xuICAgIGlmIChuZXh0ID4gdGhpcy5fY29kZUxlbmd0aCAtIDEpIHtcbiAgICAgIHRhcmdldC5ibHVyKCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5pbnB1dHNbbmV4dF0uZm9jdXMoKTtcbiAgfVxuXG4gIG9uUGFzdGUoZTogQ2xpcGJvYXJkRXZlbnQsIGk6IG51bWJlcik6IHZvaWQge1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICBlLnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgY29uc3QgZGF0YSA9IGUuY2xpcGJvYXJkRGF0YSA/IGUuY2xpcGJvYXJkRGF0YS5nZXREYXRhKCd0ZXh0JykudHJpbSgpIDogdW5kZWZpbmVkO1xuXG4gICAgaWYgKHRoaXMuaXNFbXB0eShkYXRhKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIENvbnZlcnQgcGFzdGUgdGV4dCBpbnRvIGl0ZXJhYmxlXG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLW5vbi1udWxsLWFzc2VydGlvblxuICAgIGNvbnN0IHZhbHVlcyA9IGRhdGEhLnNwbGl0KCcnKTtcbiAgICBsZXQgdmFsSW5kZXggPSAwO1xuXG4gICAgZm9yIChsZXQgaiA9IGk7IGogPCB0aGlzLmlucHV0cy5sZW5ndGg7IGorKykge1xuICAgICAgLy8gVGhlIHZhbHVlcyBlbmQgaXMgcmVhY2hlZC4gTG9vcCBleGl0XG4gICAgICBpZiAodmFsSW5kZXggPT09IHZhbHVlcy5sZW5ndGgpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGlucHV0ID0gdGhpcy5pbnB1dHNbal07XG4gICAgICBjb25zdCB2YWwgPSB2YWx1ZXNbdmFsSW5kZXhdO1xuXG4gICAgICAvLyBDYW5jZWwgdGhlIGxvb3Agd2hlbiBhIHZhbHVlIGNhbm5vdCBiZSB1c2VkXG4gICAgICBpZiAoIXRoaXMuY2FuSW5wdXRWYWx1ZSh2YWwpKSB7XG4gICAgICAgIHRoaXMuc2V0SW5wdXRWYWx1ZShpbnB1dCwgbnVsbCk7XG4gICAgICAgIHRoaXMuc2V0U3RhdGVGb3JJbnB1dChpbnB1dCwgSW5wdXRTdGF0ZS5yZXNldCk7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5zZXRJbnB1dFZhbHVlKGlucHV0LCB2YWwudG9TdHJpbmcoKSk7XG4gICAgICB2YWxJbmRleCsrO1xuICAgIH1cblxuICAgIHRoaXMuaW5wdXRzW2ldLmJsdXIoKTtcbiAgICB0aGlzLmVtaXRDaGFuZ2VzKCk7XG4gIH1cblxuICBhc3luYyBvbktleWRvd24oZTogYW55LCBpOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCB0YXJnZXQgPSBlLnRhcmdldDtcbiAgICBjb25zdCBpc1RhcmdldEVtcHR5ID0gdGhpcy5pc0VtcHR5KHRhcmdldC52YWx1ZSk7XG4gICAgY29uc3QgcHJldiA9IGkgLSAxO1xuXG4gICAgLy8gcHJvY2Vzc2luZyBvbmx5IHRoZSBiYWNrc3BhY2UgYW5kIGRlbGV0ZSBrZXkgZXZlbnRzXG4gICAgY29uc3QgaXNCYWNrc3BhY2VLZXkgPSBhd2FpdCB0aGlzLmlzQmFja3NwYWNlS2V5KGUpO1xuICAgIGNvbnN0IGlzRGVsZXRlS2V5ID0gdGhpcy5pc0RlbGV0ZUtleShlKTtcbiAgICBpZiAoIWlzQmFja3NwYWNlS2V5ICYmICFpc0RlbGV0ZUtleSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGUucHJldmVudERlZmF1bHQoKTtcblxuICAgIHRoaXMuc2V0SW5wdXRWYWx1ZSh0YXJnZXQsIG51bGwpO1xuICAgIGlmICghaXNUYXJnZXRFbXB0eSkge1xuICAgICAgdGhpcy5lbWl0Q2hhbmdlcygpO1xuICAgIH1cblxuICAgIC8vIHByZXZlbnRpbmcgdG8gZm9jdXNpbmcgb24gdGhlIHByZXZpb3VzIGZpZWxkIGlmIGl0IGRvZXMgbm90IGV4aXN0IG9yIHRoZSBkZWxldGUga2V5IGhhcyBiZWVuIHByZXNzZWRcbiAgICBpZiAocHJldiA8IDAgfHwgaXNEZWxldGVLZXkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAoaXNUYXJnZXRFbXB0eSB8fCB0aGlzLmlzUHJldkZvY3VzYWJsZUFmdGVyQ2xlYXJpbmcpIHtcbiAgICAgIHRoaXMuaW5wdXRzW3ByZXZdLmZvY3VzKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvbklucHV0Q29kZUNoYW5nZXMoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmlucHV0cy5sZW5ndGgpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5pc0VtcHR5KHRoaXMuY29kZSkpIHtcbiAgICAgIHRoaXMuaW5wdXRzLmZvckVhY2goKGlucHV0OiBIVE1MSW5wdXRFbGVtZW50KSA9PiB7XG4gICAgICAgIHRoaXMuc2V0SW5wdXRWYWx1ZShpbnB1dCwgbnVsbCk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgY29uc3QgY2hhcnMgPSB0aGlzLmNvZGUhLnRvU3RyaW5nKCkudHJpbSgpLnNwbGl0KCcnKTtcbiAgICAvLyBjaGVja2luZyBpZiBhbGwgdGhlIHZhbHVlcyBhcmUgY29ycmVjdFxuICAgIGxldCBpc0FsbENoYXJzQXJlQWxsb3dlZCA9IHRydWU7XG4gICAgZm9yIChjb25zdCBjaGFyIG9mIGNoYXJzKSB7XG4gICAgICBpZiAoIXRoaXMuY2FuSW5wdXRWYWx1ZShjaGFyKSkge1xuICAgICAgICBpc0FsbENoYXJzQXJlQWxsb3dlZCA9IGZhbHNlO1xuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmlucHV0cy5mb3JFYWNoKChpbnB1dDogSFRNTElucHV0RWxlbWVudCwgaW5kZXg6IG51bWJlcikgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBpc0FsbENoYXJzQXJlQWxsb3dlZCA/IGNoYXJzW2luZGV4XSA6IG51bGw7XG4gICAgICB0aGlzLnNldElucHV0VmFsdWUoaW5wdXQsIHZhbHVlKTtcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgb25Db2RlTGVuZ3RoQ2hhbmdlcygpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuY29kZUxlbmd0aCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuX2NvZGVMZW5ndGggPSB0aGlzLmNvZGVMZW5ndGg7XG4gICAgaWYgKHRoaXMuX2NvZGVMZW5ndGggPiB0aGlzLnBsYWNlaG9sZGVycy5sZW5ndGgpIHtcbiAgICAgIGNvbnN0IG51bWJlcnMgPSBBcnJheSh0aGlzLl9jb2RlTGVuZ3RoIC0gdGhpcy5wbGFjZWhvbGRlcnMubGVuZ3RoKS5maWxsKDEpO1xuICAgICAgdGhpcy5wbGFjZWhvbGRlcnMuc3BsaWNlKHRoaXMucGxhY2Vob2xkZXJzLmxlbmd0aCAtIDEsIDAsIC4uLm51bWJlcnMpO1xuICAgIH1cbiAgICBlbHNlIGlmICh0aGlzLl9jb2RlTGVuZ3RoIDwgdGhpcy5wbGFjZWhvbGRlcnMubGVuZ3RoKSB7XG4gICAgICB0aGlzLnBsYWNlaG9sZGVycy5zcGxpY2UodGhpcy5fY29kZUxlbmd0aCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBvbklucHV0c0xpc3RDaGFuZ2VzKGxpc3Q6IFF1ZXJ5TGlzdDxFbGVtZW50UmVmPik6IHZvaWQge1xuICAgIGlmIChsaXN0Lmxlbmd0aCA+IHRoaXMuaW5wdXRzLmxlbmd0aCkge1xuICAgICAgY29uc3QgaW5wdXRzVG9BZGQgPSBsaXN0LmZpbHRlcigoaXRlbSwgaW5kZXgpID0+IGluZGV4ID4gdGhpcy5pbnB1dHMubGVuZ3RoIC0gMSk7XG4gICAgICB0aGlzLmlucHV0cy5zcGxpY2UodGhpcy5pbnB1dHMubGVuZ3RoLCAwLCAuLi5pbnB1dHNUb0FkZC5tYXAoaXRlbSA9PiBpdGVtLm5hdGl2ZUVsZW1lbnQpKTtcbiAgICAgIGNvbnN0IHN0YXRlcyA9IEFycmF5KGlucHV0c1RvQWRkLmxlbmd0aCkuZmlsbChJbnB1dFN0YXRlLnJlYWR5KTtcbiAgICAgIHRoaXMuaW5wdXRzU3RhdGVzLnNwbGljZSh0aGlzLmlucHV0c1N0YXRlcy5sZW5ndGgsIDAsIC4uLnN0YXRlcyk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGxpc3QubGVuZ3RoIDwgdGhpcy5pbnB1dHMubGVuZ3RoKSB7XG4gICAgICB0aGlzLmlucHV0cy5zcGxpY2UobGlzdC5sZW5ndGgpO1xuICAgICAgdGhpcy5pbnB1dHNTdGF0ZXMuc3BsaWNlKGxpc3QubGVuZ3RoKTtcbiAgICB9XG5cbiAgICAvLyBmaWxsaW5nIHRoZSBpbnB1dHMgYWZ0ZXIgY2hhbmdpbmcgb2YgdGhlaXIgY291bnRcbiAgICB0aGlzLm9uSW5wdXRDb2RlQ2hhbmdlcygpO1xuICB9XG5cbiAgcHJpdmF0ZSBmb2N1c09uSW5wdXRBZnRlckFwcGVhcmluZygpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuc3RhdGUuaXNJbml0aWFsRm9jdXNGaWVsZEVuYWJsZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zdGF0ZS5pc0ZvY3VzaW5nQWZ0ZXJBcHBlYXJpbmdDb21wbGV0ZWQpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgdGhpcy5mb2N1c09uRmllbGQodGhpcy5pbml0aWFsRm9jdXNGaWVsZCEpO1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICB0aGlzLnN0YXRlLmlzRm9jdXNpbmdBZnRlckFwcGVhcmluZ0NvbXBsZXRlZCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IHRoaXMuaW5wdXRzW3RoaXMuaW5pdGlhbEZvY3VzRmllbGQhXTtcbiAgfVxuXG4gIHByaXZhdGUgZW1pdENoYW5nZXMoKTogdm9pZCB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmVtaXRDb2RlKCksIDUwKTtcbiAgfVxuXG4gIHByaXZhdGUgZW1pdENvZGUoKTogdm9pZCB7XG4gICAgY29uc3QgY29kZSA9IHRoaXMuZ2V0Q3VycmVudEZpbGxlZENvZGUoKTtcblxuICAgIHRoaXMuY29kZUNoYW5nZWQuZW1pdChjb2RlKTtcblxuICAgIGlmIChjb2RlLmxlbmd0aCA+PSB0aGlzLl9jb2RlTGVuZ3RoKSB7XG4gICAgICB0aGlzLmNvZGVDb21wbGV0ZWQuZW1pdChjb2RlKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGdldEN1cnJlbnRGaWxsZWRDb2RlKCk6IHN0cmluZyB7XG4gICAgbGV0IGNvZGUgPSAnJztcblxuICAgIGZvciAoY29uc3QgaW5wdXQgb2YgdGhpcy5pbnB1dHMpIHtcbiAgICAgIGlmICghdGhpcy5pc0VtcHR5KGlucHV0LnZhbHVlKSkge1xuICAgICAgICBjb2RlICs9IGlucHV0LnZhbHVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBjb2RlO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0JhY2tzcGFjZUtleShlOiBhbnkpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBpc0JhY2tzcGFjZSA9IChlLmtleSAmJiBlLmtleS50b0xvd2VyQ2FzZSgpID09PSAnYmFja3NwYWNlJykgfHwgKGUua2V5Q29kZSAmJiBlLmtleUNvZGUgPT09IDgpO1xuICAgIGlmIChpc0JhY2tzcGFjZSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh0cnVlKTtcbiAgICB9XG5cbiAgICAvLyBwcm9jZXNzIG9ubHkga2V5IHdpdGggcGxhY2Vob2xkZXIga2V5Y29kZSBvbiBhbmRyb2lkIGRldmljZXNcbiAgICBpZiAoIWUua2V5Q29kZSB8fCBlLmtleUNvZGUgIT09IDIyOSkge1xuICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZShmYWxzZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlPGJvb2xlYW4+KChyZXNvbHZlKSA9PiB7XG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgY29uc3QgaW5wdXQgPSBlLnRhcmdldDtcbiAgICAgICAgY29uc3QgaXNSZXNldCA9IHRoaXMuZ2V0U3RhdGVGb3JJbnB1dChpbnB1dCkgPT09IElucHV0U3RhdGUucmVzZXQ7XG4gICAgICAgIGlmIChpc1Jlc2V0KSB7XG4gICAgICAgICAgdGhpcy5zZXRTdGF0ZUZvcklucHV0KGlucHV0LCBJbnB1dFN0YXRlLnJlYWR5KTtcbiAgICAgICAgfVxuICAgICAgICAvLyBpZiBiYWNrc3BhY2Uga2V5IHByZXNzZWQgdGhlIGNhcmV0IHdpbGwgaGF2ZSBwb3NpdGlvbiAwIChmb3Igc2luZ2xlIHZhbHVlIGZpZWxkKVxuICAgICAgICByZXNvbHZlKGlucHV0LnNlbGVjdGlvblN0YXJ0ID09PSAwICYmICFpc1Jlc2V0KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBpc0RlbGV0ZUtleShlOiBhbnkpOiBib29sZWFuIHtcbiAgICByZXR1cm4gKGUua2V5ICYmIGUua2V5LnRvTG93ZXJDYXNlKCkgPT09ICdkZWxldGUnKSB8fCAoZS5rZXlDb2RlICYmIGUua2V5Q29kZSA9PT0gNDYpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRJbnB1dFZhbHVlKGlucHV0OiBIVE1MSW5wdXRFbGVtZW50LCB2YWx1ZTogYW55KTogdm9pZCB7XG4gICAgY29uc3QgaXNFbXB0eSA9IHRoaXMuaXNFbXB0eSh2YWx1ZSk7XG4gICAgY29uc3QgdmFsdWVDbGFzc0NTUyA9ICdoYXMtdmFsdWUnO1xuICAgIGNvbnN0IGVtcHR5Q2xhc3NDU1MgPSAnZW1wdHknO1xuICAgIGlmIChpc0VtcHR5KSB7XG4gICAgICBpbnB1dC52YWx1ZSA9ICcnO1xuICAgICAgaW5wdXQuY2xhc3NMaXN0LnJlbW92ZSh2YWx1ZUNsYXNzQ1NTKTtcbiAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTpuby1ub24tbnVsbC1hc3NlcnRpb25cbiAgICAgIGlucHV0LnBhcmVudEVsZW1lbnQhLmNsYXNzTGlzdC5hZGQoZW1wdHlDbGFzc0NTUyk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgaW5wdXQudmFsdWUgPSB2YWx1ZTtcbiAgICAgIGlucHV0LmNsYXNzTGlzdC5hZGQodmFsdWVDbGFzc0NTUyk7XG4gICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICBpbnB1dC5wYXJlbnRFbGVtZW50IS5jbGFzc0xpc3QucmVtb3ZlKGVtcHR5Q2xhc3NDU1MpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2FuSW5wdXRWYWx1ZSh2YWx1ZTogYW55KTogYm9vbGVhbiB7XG4gICAgaWYgKHRoaXMuaXNFbXB0eSh2YWx1ZSkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBjb25zdCBpc0RpZ2l0c1ZhbHVlID0gL15bMC05XSskLy50ZXN0KHZhbHVlLnRvU3RyaW5nKCkpO1xuICAgIHJldHVybiBpc0RpZ2l0c1ZhbHVlIHx8ICh0aGlzLmlzQ2hhcnNDb2RlIHx8IHRoaXMuaXNOb25EaWdpdHNDb2RlKTtcbiAgfVxuXG4gIHByaXZhdGUgc2V0U3RhdGVGb3JJbnB1dChpbnB1dDogSFRNTElucHV0RWxlbWVudCwgc3RhdGU6IElucHV0U3RhdGUpOiB2b2lkIHtcbiAgICBjb25zdCBpbmRleCA9IHRoaXMuaW5wdXRzLmluZGV4T2YoaW5wdXQpO1xuICAgIGlmIChpbmRleCA8IDApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmlucHV0c1N0YXRlc1tpbmRleF0gPSBzdGF0ZTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U3RhdGVGb3JJbnB1dChpbnB1dDogSFRNTElucHV0RWxlbWVudCk6IElucHV0U3RhdGUgfCB1bmRlZmluZWQge1xuICAgIGNvbnN0IGluZGV4ID0gdGhpcy5pbnB1dHMuaW5kZXhPZihpbnB1dCk7XG4gICAgcmV0dXJuIHRoaXMuaW5wdXRzU3RhdGVzW2luZGV4XTtcbiAgfVxuXG4gIHByaXZhdGUgaXNFbXB0eSh2YWx1ZTogYW55KTogYm9vbGVhbiB7XG4gICAgcmV0dXJuICB2YWx1ZSA9PT0gbnVsbCB8fCB2YWx1ZSA9PT0gdW5kZWZpbmVkIHx8ICF2YWx1ZS50b1N0cmluZygpLmxlbmd0aDtcbiAgfVxufVxuIl19